{{- define "common.service" -}}
{{- $common := dict "Values" .Values.common -}} 
{{- $noCommon := omit .Values "common" -}} 
{{- $module := dict "Values" (index .Values (tpl .Chart.Name .)) -}} 
{{- $noModule := omit (index .Values (tpl .Chart.Name .)) -}} 
{{- $overrides := dict "Values" (merge $noModule $noCommon ) -}} 
{{- $noValues := omit . "Values" -}} 
{{- with merge $noValues $overrides $common }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Chart.Name }}
  namespace: {{ .Release.Namespace }}   
  annotations: 
{{- if .Values.metrics }}   
    prometheus.io/path: {{ .Values.metrics.path | quote }}
    prometheus.io/port: {{ .Values.metrics.port | quote }}
    prometheus.io/scrape: "true"  
{{- end }}
{{- if .Values.ingress.zuul }} 
    zuul/route-path: {{ .Values.ingress.context }}
{{- end }}
  labels:
{{- include "common.labels" . | nindent 4 }}   
spec:
  selector: 
{{- include "common.labels" . | nindent 4 }}    
  ports:
  - port: {{ .Values.httpPort }}
    targetPort: {{ .Values.targetHttpPort }}  
{{- end -}}
{{- end -}}   